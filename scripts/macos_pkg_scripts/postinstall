#!/bin/bash
set -euo pipefail

# Berry macOS pkg postinstall
#
# Goals (best practice):
# - Verify the payload actually installed and the binary runs.
# - Perform optional *best-effort* client integration for the active console user.
#   (Never fail the installation just because a client CLI isn't installed.)
#
# Note: macOS installer scripts run as root.

LOG_FILE="/var/log/berry-install.log"

log() {
  echo "[berry][postinstall] $*"
}

# Mirror output into a stable log file for support/debugging.
if command -v /usr/bin/tee >/dev/null 2>&1; then
  exec > >(/usr/bin/tee -a "$LOG_FILE") 2>&1
fi

BERRY_BIN="/usr/local/bin/berry"
if [[ ! -x "$BERRY_BIN" ]]; then
  log "ERROR: expected berry binary not found or not executable: $BERRY_BIN"
  exit 1
fi

VERSION="$($BERRY_BIN version 2>/dev/null || true)"
if [[ -z "$VERSION" ]]; then
  log "ERROR: 'berry version' failed."
  exit 1
fi

log "Installed berry version: $VERSION"
log "Binary: $BERRY_BIN"

# Optional: attempt global MCP registration for installed client CLIs.
#
# This is run as the active console user (not root) because these client tools
# typically store config under the user's home directory.
CONSOLE_USER="$(/usr/bin/stat -f%Su /dev/console 2>/dev/null || true)"

if [[ -z "$CONSOLE_USER" || "$CONSOLE_USER" == "root" ]]; then
  log "Console user not detected (or root). Skipping client integration."
  log "Next steps: in each repo, run 'berry init'."
  exit 0
fi

# Optional: seed default env for MCP launches (used by `berry init` / deeplinks).
#
# This writes ~/.berry/mcp_env.json for the console user. It is intentionally
# best-effort: it should never fail the installation.

DEFAULT_OPENAI_BASE_URL="http://20.232.57.156/v1"
DEFAULT_BERRY_SERVICE_URL="http://52.191.234.157:8000"

USER_HOME="$(/usr/bin/dscl . -read "/Users/$CONSOLE_USER" NFSHomeDirectory 2>/dev/null | /usr/bin/awk '{print $2}' || true)"
if [[ -z "$USER_HOME" ]]; then
  USER_HOME="$(/usr/bin/su -l "$CONSOLE_USER" -c 'printf "%s" "$HOME"' 2>/dev/null || true)"
fi

if [[ -n "$USER_HOME" ]]; then
  BERRY_HOME="$USER_HOME/.berry"
  MCP_ENV_FILE="$BERRY_HOME/mcp_env.json"

  if [[ ! -f "$MCP_ENV_FILE" ]]; then
    # Allow packagers to override at install-time without hardcoding secrets.
    OPENAI_BASE_URL_VALUE="${BERRY_INSTALL_OPENAI_BASE_URL:-$DEFAULT_OPENAI_BASE_URL}"
    BERRY_SERVICE_URL_VALUE="${BERRY_INSTALL_BERRY_SERVICE_URL:-$DEFAULT_BERRY_SERVICE_URL}"
    OPENAI_API_KEY_VALUE="${BERRY_INSTALL_OPENAI_API_KEY:-${OPENAI_API_KEY:-}}"

    mkdir -p "$BERRY_HOME" || true
    chmod 700 "$BERRY_HOME" 2>/dev/null || true

    if [[ -n "$OPENAI_API_KEY_VALUE" ]]; then
      /bin/cat >"$MCP_ENV_FILE" <<EOF
{
  "BERRY_SERVICE_URL": "${BERRY_SERVICE_URL_VALUE}",
  "OPENAI_BASE_URL": "${OPENAI_BASE_URL_VALUE}",
  "OPENAI_API_KEY": "${OPENAI_API_KEY_VALUE}"
}
EOF
    else
      /bin/cat >"$MCP_ENV_FILE" <<EOF
{
  "BERRY_SERVICE_URL": "${BERRY_SERVICE_URL_VALUE}",
  "OPENAI_BASE_URL": "${OPENAI_BASE_URL_VALUE}"
}
EOF
    fi

    /usr/sbin/chown "$CONSOLE_USER" "$BERRY_HOME" 2>/dev/null || true
    /usr/sbin/chown "$CONSOLE_USER" "$MCP_ENV_FILE" 2>/dev/null || true
    chmod 600 "$MCP_ENV_FILE" 2>/dev/null || true

    if [[ -n "$OPENAI_API_KEY_VALUE" ]]; then
      log "Seeded MCP env defaults: BERRY_SERVICE_URL, OPENAI_BASE_URL, OPENAI_API_KEY set."
    else
      log "Seeded MCP env defaults: BERRY_SERVICE_URL, OPENAI_BASE_URL set; OPENAI_API_KEY not set."
      log "If needed, set it later in: $MCP_ENV_FILE"
    fi
  else
    log "MCP env defaults already exist: $MCP_ENV_FILE (not overwriting)."
  fi
else
  log "Could not determine console user's home directory; skipping MCP env defaults."
fi

INTEGRATE_CMD="$BERRY_BIN integrate --global --noninteractive"
log "Attempting best-effort client integration for console user: $CONSOLE_USER"
log "Command: $INTEGRATE_CMD"

# Never fail install on integration issues (missing client CLIs, etc.).
# Ensure /usr/local/bin is in PATH for the user session.
if /usr/bin/su -l "$CONSOLE_USER" -c "PATH=/usr/local/bin:/usr/bin:/bin:/usr/sbin:/sbin; $INTEGRATE_CMD"; then
  log "Client integration completed."
else
  log "Client integration failed (non-fatal)."
  log "You can retry manually (as your user): $INTEGRATE_CMD"
fi

# Optional: write system-managed config files for clients that support it
# (Claude Code managed-mcp.json, Gemini CLI system settings). This requires
# admin rights and is appropriate for a .pkg installer.
#
# IMPORTANT: The managed integration runs as root, but we need to use the
# console user's MCP env settings (API key, service URLs). We pass these via
# BERRY_MCP_ENV_JSON to avoid reading from root's home directory.
MANAGED_CMD="$BERRY_BIN integrate --managed-only --noninteractive"
log "Attempting system-managed MCP integration (best-effort)."
log "Command: $MANAGED_CMD"

# Build the MCP env JSON to pass to the managed integration
OPENAI_BASE_URL_VALUE="${BERRY_INSTALL_OPENAI_BASE_URL:-$DEFAULT_OPENAI_BASE_URL}"
BERRY_SERVICE_URL_VALUE="${BERRY_INSTALL_BERRY_SERVICE_URL:-$DEFAULT_BERRY_SERVICE_URL}"
OPENAI_API_KEY_VALUE="${BERRY_INSTALL_OPENAI_API_KEY:-${OPENAI_API_KEY:-}}"

# Read existing mcp_env.json from console user if it exists (to get their API key)
if [[ -n "$USER_HOME" && -f "$USER_HOME/.berry/mcp_env.json" ]]; then
  # Try to extract API key from user's existing config
  EXISTING_KEY="$(/usr/bin/python3 -c "import json; d=json.load(open('$USER_HOME/.berry/mcp_env.json')); print(d.get('OPENAI_API_KEY',''))" 2>/dev/null || true)"
  if [[ -n "$EXISTING_KEY" ]]; then
    OPENAI_API_KEY_VALUE="$EXISTING_KEY"
  fi
fi

if [[ -n "$OPENAI_API_KEY_VALUE" ]]; then
  MCP_ENV_JSON="{\"BERRY_SERVICE_URL\":\"${BERRY_SERVICE_URL_VALUE}\",\"OPENAI_BASE_URL\":\"${OPENAI_BASE_URL_VALUE}\",\"OPENAI_API_KEY\":\"${OPENAI_API_KEY_VALUE}\"}"
else
  MCP_ENV_JSON="{\"BERRY_SERVICE_URL\":\"${BERRY_SERVICE_URL_VALUE}\",\"OPENAI_BASE_URL\":\"${OPENAI_BASE_URL_VALUE}\"}"
fi

if BERRY_MCP_ENV_JSON="$MCP_ENV_JSON" $MANAGED_CMD; then
  log "System-managed integration completed."
else
  log "System-managed integration failed (non-fatal)."
fi

log "Next steps: in each repo you want to use Berry, run 'berry init'."
exit 0
